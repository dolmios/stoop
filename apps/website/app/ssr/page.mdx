# Server-Side Rendering (SSR)

<Icon name="Server" size={24} style={{ display: "inline", verticalAlign: "middle", marginRight: "8px" }} /> Use Stoop with Next.js App Router for perfect SSR support

## Overview

Stoop fully supports Next.js App Router with zero FOUC (Flash of Unstyled Content). The recommended pattern uses `useServerInsertedHTML` to capture styles during SSR streaming.

For detailed API documentation, see:
- <Icon name="FileCode" size={16} style={{ display: "inline", verticalAlign: "middle", marginRight: "4px" }} /> **[getCssText API](/api/get-css-text)** - Get all generated CSS text for SSR
- <Icon name="Lightning" size={16} style={{ display: "inline", verticalAlign: "middle", marginRight: "4px" }} /> **[preloadTheme API](/api/preload-theme)** - Preload theme CSS variables to prevent FOUC

## SSR Entry Point (`stoop/ssr`)

For Server Components in Next.js App Router, use the SSR entry point to avoid bundling React code:

```typescript
// app/components/ServerComponent.tsx
import { createStoop } from "stoop/ssr";

const stoop = createStoop({
  theme: {
    colors: { primary: "#0070f3" },
    space: { medium: "16px" },
  },
});

// Returns StoopServerInstance (no React APIs)
// Available: css, globalCss, keyframes, getCssText, warmCache, preloadTheme, createTheme, theme, config
// NOT available: styled, Provider, useTheme

// Usage in Server Component
const className = stoop.css({
  padding: "$medium",
  color: "$primary",
});
```

**When to use**:
- Server Components (no React APIs needed)
- Server-side CSS generation
- SSR with `getCssText()`

**When NOT to use**:
- Client Components (use regular `stoop` import)
- Components using `styled()` or `useTheme()`

**Note:** For build-time CSS extraction, see the separate [`stoop-swc`](https://github.com/dolmios/stoop/tree/main/packages/stoop-swc) package. The core `stoop` package generates CSS at runtime.

## Next.js App Router (Recommended)

### Step 1: Create Styles Component

Create a client component that handles SSR style injection:

```typescript
// app/components/Styles.tsx
"use client";

import { useServerInsertedHTML } from "next/navigation";
import { getCssText } from "../../stoop.theme";

export function Styles({ initialTheme }: { initialTheme: string }) {
  useServerInsertedHTML(() => {
    // Global styles are automatically included from theme config
    // No need to call them manually - Provider handles this automatically
    // Note: getCssText() always includes all themes, the parameter is ignored
    const cssText = getCssText();

    if (!cssText) return null;

    return (
      <style
        id="stoop-ssr"
        dangerouslySetInnerHTML={{ __html: cssText }}
        suppressHydrationWarning
      />
    );
  });

  return null;
}
```

### Step 2: Use in Root Layout

Add the `Styles` component to your root layout:

```typescript
// app/layout.tsx
import { cookies } from "next/headers";
import { type ReactNode } from "react";
import { Provider } from "../stoop.theme";
import { Styles } from "./components/Styles";

export default async function RootLayout({ children }: { children: ReactNode }) {
  // Detect theme from cookies on server
  const cookieStore = await cookies();
  const themeCookie = cookieStore.get("stoop-theme");
  const initialTheme = themeCookie?.value || "light";

  return (
    <html lang="en" data-theme={initialTheme} suppressHydrationWarning>
      <body>
        {/* Inject SSR styles - prevents FOUC */}
        <Styles initialTheme={initialTheme} />

        {/* Wrap app with theme provider */}
        <Provider defaultTheme={initialTheme} storageKey="stoop-theme">
          {children}
        </Provider>
      </body>
    </html>
  );
}
```

### Preventing FOUC (Flash of Unstyled Content)

To prevent FOUC when loading a theme from localStorage, use `preloadTheme()`:

```typescript
// app/layout.tsx
"use client";

import { useEffect, type ReactNode } from "react";
import { preloadTheme } from "./theme";

export default function RootLayout({ children }: { children: ReactNode }) {
  useEffect(() => {
    // Preload all themes before React renders to prevent FOUC
    preloadTheme();
  }, []);

  return <>{children}</>;
}
```

For a more robust solution, create a script that runs before React:

```typescript
// app/layout.tsx
import Script from "next/script";
import { type ReactNode } from "react";
import { getCssText } from "./theme";

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html>
      <head>
        <style
          id="stoop-styles"
          dangerouslySetInnerHTML={{ __html: getCssText() }}
        />
        <Script
          id="stoop-theme-preload"
          strategy="beforeInteractive"
          dangerouslySetInnerHTML={{
            __html: `
              (function() {
                const savedTheme = localStorage.getItem('stoop-theme');
                if (savedTheme) {
                  // Preload theme CSS variables synchronously
                  // This prevents FOUC
                }
              })();
            `,
          }}
        />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

## Next.js Pages Router

### Basic Setup

In your `pages/_document.tsx`, inject the CSS:

```typescript
import { Html, Head, Main, NextScript } from "next/document";
import { getCssText } from "../theme";

export default function Document() {
  return (
    <Html>
      <Head>
        <style
          id="stoop-styles"
          dangerouslySetInnerHTML={{ __html: getCssText() }}
        />
      </Head>
      <body>
        <Main />
        <NextScript />
      </body>
    </Html>
  );
}
```

### With Theme Support

```typescript
import { Html, Head, Main, NextScript } from "next/document";
import { getCssText } from "../theme";

export default function Document() {
  // Always call with no parameters - includes all themes automatically
  const cssText = getCssText();

  return (
    <Html>
      <Head>
        <style
          id="stoop-styles"
          dangerouslySetInnerHTML={{ __html: cssText }}
        />
      </Head>
      <body>
        <Main />
        <NextScript />
      </body>
    </Html>
  );
}
```

## API Reference

For complete API documentation, see:
- **[getCssText](/api/get-css-text)** - Complete API reference with parameters and examples
- **[preloadTheme](/api/preload-theme)** - Complete API reference with FOUC prevention examples

## Hydration Behavior

The Provider always starts with the default theme to match SSR output, preventing hydration mismatches. Theme preferences are restored from storage in `useLayoutEffect` after mount. This ensures:
- Server renders with default theme
- Client hydrates with default theme (matches server)
- Theme preference is restored after hydration (no mismatch)

## Best Practices

1. **Always call `getCssText()` in your document/layout** - This ensures styles are available on initial render
2. **Use Provider for theme management** - The Provider automatically handles theme preloading and prevents FOUC
3. **Include theme variables** - `getCssText()` automatically includes CSS variables for all configured themes
4. **No theme parameter needed** - Always call `getCssText()` with no parameters - it includes all themes automatically
5. **Use SSR entry point for Server Components** - Import from `stoop/ssr` in Server Components to avoid bundling React code

## Common Issues

### Styles not appearing on initial load

Make sure you're calling `getCssText()` in your document/layout and the styles are injected before React hydrates.

### FOUC with theme switching

The Provider component automatically handles theme preloading. If you need manual control, use `preloadTheme()` before React renders, but this is usually not necessary.

### Theme not found warning

This warning should not occur since `getCssText()` doesn't use the theme parameter. If you see this, ensure your `themes` config is properly set up in `createStoop`.

## Related Pages

- <Icon name="Palette" size={16} style={{ display: "inline", verticalAlign: "middle", marginRight: "4px" }} /> [Theme Setup](/theme-setup) - Configure themes for SSR
- <Icon name="Book" size={16} style={{ display: "inline", verticalAlign: "middle", marginRight: "4px" }} /> [API Reference: getCssText](/api/get-css-text) - Complete getCssText documentation
- <Icon name="Book" size={16} style={{ display: "inline", verticalAlign: "middle", marginRight: "4px" }} /> [API Reference: preloadTheme](/api/preload-theme) - Complete preloadTheme documentation

