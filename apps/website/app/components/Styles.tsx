"use client";

import { useServerInsertedHTML } from "next/navigation";
import { useRef } from "react";
import { getCssText } from "stoop-ui";

/**
 * Injects SSR-generated CSS into the document head.
 * Uses Next.js streaming SSR to capture styles as components render.
 *
 * How it works:
 * 1. During SSR, useServerInsertedHTML captures all CSS generated by stoop-ui
 * 2. CSS is injected into a <style id="stoop-ssr"> tag in the HTML stream
 * 3. On client hydration, the same tag is reused (no FOUC)
 * 4. CSS variables for all configured themes are included (using attribute selectors)
 * 5. Global styles are automatically included from the theme config
 *    (Provider handles injection automatically from globalCss config)
 *
 * @param initialTheme - The initial theme name (e.g., "light" or "dark")
 */
export function Styles({ initialTheme }: { initialTheme: string }): null {
  const isInjected = useRef(false);

  useServerInsertedHTML(() => {
    // Prevent multiple injections during SSR streaming
    if (isInjected.current) {
      return null;
    }

    isInjected.current = true;

    // Global styles are automatically included from theme config
    // Provider handles injection automatically
    // Note: getCssText() always includes all themes, the parameter is ignored
    const cssText = getCssText();

    if (!cssText) {
      return null;
    }

    return (
      <style
        dangerouslySetInnerHTML={{ __html: cssText }}
        id="stoop-ssr"
        suppressHydrationWarning
      />
    );
  });

  return null;
}
